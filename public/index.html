<html>

<head>
  <title>Touch My Hand</title>
  <script src="https://aframe.io/releases/0.7.0/aframe.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.5/socket.io.min.js"></script>
  <script src="easyrtc/easyrtc.js"></script>
  <script src="https://unpkg.com/networked-aframe/dist/networked-aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-environment-component@1.1.0/dist/aframe-environment-component.min.js"></script>
</head>

<body style="background-color: black">
  <script>
      const round = (num, pres) => Math.round(num * pres) / pres;

      AFRAME.registerComponent('show-parent-loc', {
        tick() {
          const location = new THREE.Vector3();
          this.el.parentEl.object3D.getWorldPosition(location);
          AFRAME.utils.entity.setComponentProperty(
            this.el,
            'value',
            round(location.x, 10) + ' ' + round(location.z, 10)
          );
        },
      });

      AFRAME.registerComponent('shift', {
        schema: {
          rotation: {type: 'number', default: 0},
        },
      });

      AFRAME.registerComponent('rotate-world', {
        init() {
          this.el.addEventListener('abuttondown', () => {
            this.rotate();
          });
        },
        rotate() {
          const head = document.getElementById('head');
          const x = head.object3D.position.x;
          const z = head.object3D.position.z;
          const angle = Math.atan2(x, z) + Math.PI;

          AFRAME.utils.entity.setComponentProperty(
            head.parentEl,
            'shift.rotation',
            angle,
          );

          world.object3D.rotation.set(
            0,
            angle,
            0,
          );
        },
      });

      const updateOthers = () => {
        const othersContainer = document.getElementById('others-container');

        Array.from(document.querySelectorAll('a-scene > a-entity[networked]')).map(e => {
          const shift = e.components.shift;
          if (!shift || !shift.data.rotation) {
            return;
          }

          console.log(shift.data.rotation);
          remoteParent = document.createElement('a-entity');
          othersContainer.appendChild(remoteParent);
          remoteParent.appendChild(e);
          setTimeout(() => {
            remoteParent.object3D.rotation.set(
              0,
              -shift.data.rotation,
              0,
            );
          }, 1000);

        });
      }

      setInterval(updateOthers, 1000);
    </script>
  <a-scene networked-scene animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
    <a-assets>
      <template id="player-template">
        <a-entity shift></a-entity>
      </template>
      <template id="head-template">
        <a-box color="yellow" class="head" scale=".4 .4 .4">
          <a-text position="0 1 0" show-parent-loc></a-text>
        </a-box>
      </template>
      <template id="left-hand-template">
        <a-box color="yellow" height=".05" depth=".05" width=".05"></a-box>
      </template>
      <template id="right-hand-template">
        <a-box color="yellow" height=".05" depth=".05" width=".05"></a-box>
      </template>
    </a-assets>
    <a-entity environment="preset: tron; ground: none"></a-entity>

    <a-entity id="player-container">
      <a-entity id="player" shift networked="template:#player-template;attachTemplateToLocal:false;">
        <a-entity camera id="head" class="head" wasd-controls="fly: true" look-controls
          networked="template:#head-template;attachTemplateToLocal:false;">
          <a-text position="0 1 -3" show-parent-loc></a-text>
        </a-entity>
        <a-entity oculus-touch-controls="hand: left" rotate-world networked="template:#left-hand-template">
          <a-box color="yellow" height=".05" depth=".05" width=".05"></a-box>
        </a-entity>
        <a-entity oculus-touch-controls="hand: right" rotate-world networked="template:#right-hand-template">
          <a-box color="yellow" height=".05" depth=".05" width=".05"></a-box>
        </a-entity>
      </a-entity>
    </a-entity>



    <a-entity id="world">
        <a-entity id="others-container"></a-entity>
        <a-box height=".05" position="-11 0 -25.5" material="" color="green" geometry="width:22;depth:51"></a-box>
        <a-box height="50" position="0 25 -50" color="black" geometry="width:.1;depth:.1"></a-box>
    </a-entity>

    <a-entity position="0 -1 0" visible="false">
        <a-box height=".05" position="-0.5 0 -0.5" material="" color="green"></a-box>
        <a-box height=".05" position="0.5 0 0.5" material="" color="yellow"></a-box>
        <a-box height=".05" position="0.5 0 -0.5" material="" color="red"></a-box>
        <a-box height=".05" position="-0.5 0 0.5" material="" color="blue"></a-box>
    </a-entity>
    <!-- <a-box width=".9" depth=".05" height="2" position="0 1 0"></a-box> -->
  </a-scene>
  <script>
      NAF.schemas.add({
        template: '#player-template',
        components: [
          'position',
          'rotation',
          'shift',
        ]
      });
  </script>
</body>

</html>
